<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KOBRA & OTP - نظام الحسابات</title>
  <style>
    *{box-sizing:border-box;font-family: "Poppins",sans-serif}
    body{
      margin:0;min-height:100vh;
      display:flex;align-items:center;justify-content:center;
      background:radial-gradient(circle at center,#000010 0%,#000 100%);
      color:#00eaff;
      padding:20px;
    }
    .card{
      width:360px;background:rgba(8,8,12,0.95);
      border:1px solid #00bfff;border-radius:14px;padding:22px;
      box-shadow:0 6px 30px rgba(0,191,255,0.08);text-align:center;
    }
    h2{margin-bottom:12px;color:#00eaff}
    .input{width:100%;padding:10px;border-radius:10px;border:none;background:#111;color:#00eaff;margin:8px 0}
    .btn{width:100%;padding:10px;border-radius:12px;border:none;background:linear-gradient(90deg,#00bfff,#0077ff);color:#fff;font-weight:700;cursor:pointer;margin-top:8px}
    .muted{font-size:12px;color:#7fd8ff;opacity:0.8}
    .small{font-size:13px}
    #adminPanel,#userPanel{display:none;margin-top:12px;text-align:left}
    .list{background:#071018;padding:10px;border-radius:8px;max-height:180px;overflow:auto;margin-top:10px;color:#bff7ff;font-size:13px}
    .row{display:flex;gap:8px}
    .two{display:flex;gap:8px}
    .link{background:transparent;border:1px dashed #00bfff;padding:6px;border-radius:8px;color:#00eaff;cursor:pointer;width:100%;}
  </style>
</head>
<body>
  <div class="card" id="authCard">
    <h2>KOBRA & OTP GROUP ⚡</h2>

    <!-- Login / Register -->
    <input id="username" class="input" placeholder="اسم المستخدم" />
    <input id="password" class="input" placeholder="كلمة المرور" />
    <div class="row">
      <button class="btn" onclick="doLogin()">تسجيل دخول</button>
      <button class="btn" onclick="doRegister()">تسجيل حساب جديد</button>
    </div>
    <div class="muted small" style="margin-top:10px">كوبرا بيمسي: <b>⚡</b> / <b>💘</b></div>

    <!-- Admin Panel (owner mm) -->
    <div id="adminPanel">
      <h3 style="color:#00eaff;margin-top:6px">لوحة المالك</h3>
      <div class="two">
        <input type="file" id="fileInput" accept=".txt" style="display:none" onchange="handleFile(event)">
        <button class="link" onclick="document.getElementById('fileInput').click()">📁 رفع ملف (يضيف أرقام لكل الحسابات)</button>
        <button class="link" onclick="generateAccounts()">⚙️ توليد حسابات جديدة</button>
      </div>
      <div id="adminMessage" class="muted small" style="margin-top:8px"></div>
      <div id="allAccounts" class="list"></div>
    </div>

    <!-- User Panel -->
    <div id="userPanel">
      <h3 style="color:#00eaff;margin-top:8px">صفحتك</h3>
      <div id="welcome" class="muted small"></div>
      <div style="margin-top:8px">
        <button class="link" onclick="logout()">تسجيل خروج</button>
      </div>
      <div style="margin-top:10px">
        <b>الأرقام الخاصة بك:</b>
        <div id="myNumbers" class="list">لا يوجد أرقام حتى الآن.</div>
      </div>
    </div>

  </div>

  <script>
    /***************************
     * تخزين الحسابات في localStorage
     * structure: accounts = [{username, password, numbers: []}, ...]
     ***************************/
    const STORAGE_KEY = "kobra_accounts_v1";
    const SESSION_KEY = "kobra_session_v1";

    // تحميل الحسابات من التخزين أو انشاؤها إن لم تكن موجودة
    function loadAccounts(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        const seed = [
          {username: "mm", password: "mm", numbers: []} // مالك افتراضي
        ];
        localStorage.setItem(STORAGE_KEY, JSON.stringify(seed));
        return seed;
      }
      try {
        return JSON.parse(raw);
      } catch(e){
        return [{username:"mm",password:"mm",numbers:[]}];
      }
    }

    function saveAccounts(accounts){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(accounts));
    }

    // جلسة المستخدم الحالي
    function setSession(username){
      localStorage.setItem(SESSION_KEY, username);
    }
    function clearSession(){ localStorage.removeItem(SESSION_KEY); }
    function getSession(){ return localStorage.getItem(SESSION_KEY); }

    // واجهة: عرض كل الحسابات في لوحة المالك
    function renderAdminAccounts(){
      const accounts = loadAccounts();
      const el = document.getElementById('allAccounts');
      if (!el) return;
      if (accounts.length === 0) { el.innerHTML = "لا توجد حسابات."; return; }
      el.innerHTML = accounts.map(a => {
        const n = a.numbers && a.numbers.length ? a.numbers.join("<br>") : "<i>لا أرقام</i>";
        return `<div style="padding:8px;border-bottom:1px solid rgba(0,191,255,0.06)">
                  <b>${escapeHtml(a.username)}</b> | <span class="muted"> ${escapeHtml(a.password)}</span>
                  <div style="margin-top:6px;font-size:12px;color:#bff7ff">${n}</div>
                </div>`;
      }).join("");
    }

    // توليد حسابات عشوائية وحفظها
    function generateAccounts(count = 5){
      const accounts = loadAccounts();
      let created = [];
      for (let i=0;i<count;i++){
        let uname;
        // ضمان عدم تكرار اليوزر
        do {
          uname = "user" + Math.floor(Math.random()*90000 + 1000);
        } while (accounts.some(a => a.username === uname));
        const pwd = Math.random().toString(36).slice(2,9);
        accounts.push({username: uname, password: pwd, numbers: []});
        created.push({username:uname,password:pwd});
      }
      saveAccounts(accounts);
      document.getElementById('adminMessage').innerText = "✅ تم توليد الحسابات وحفظها.";
      renderAdminAccounts();
      // عرض الحسابات المولدة للمُستخدم
      alert("الحسابات المولدة:\n" + created.map(c => `${c.username} | ${c.password}`).join("\n"));
    }

    // رفع ملف نصي و إضافة الأرقام لكل الحسابات
    function handleFile(e){
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt){
        const content = evt.target.result;
        // التقاط الأرقام: تسلسل رقمي (يمكن تعديل التعبير ليتناسب مع الشكل)
        const nums = content.match(/\d+/g);
        if (!nums || nums.length === 0) {
          alert("⚠️ لم يتم العثور على أرقام في الملف.");
          return;
        }
        const accounts = loadAccounts();
        // إزالة المسافات المكررة داخل القائمة ودمجها مع القوائم الموجودة
        accounts.forEach(acc => {
          if (!acc.numbers) acc.numbers = [];
          // أضف الأرقام فقط إذا لم تكن موجودة
          nums.forEach(n => { if (!acc.numbers.includes(n)) acc.numbers.push(n); });
        });
        saveAccounts(accounts);
        document.getElementById('adminMessage').innerText = `✅ تم إضافة ${nums.length} رقم لجميع الحسابات.`;
        renderAdminAccounts();
        // تحديث صفحة المستخدم لو كان مسجل
        const sess = getSession();
        if (sess) renderUserPanel(sess);
      };
      reader.readAsText(file, "utf-8");
      // تفريغ قيمة input عشان تقدر ترفع نفس الملف مرة ثانية إن رغبت
      e.target.value = "";
    }

    // تسجيل جديد (مستخدم عادي)
    function doRegister(){
      const u = document.getElementById('username').value.trim();
      const p = document.getElementById('password').value.trim();
      if (!u || !p) { alert("اكتب اسم مستخدم و كلمة مرور"); return;}
      const accounts = loadAccounts();
      if (accounts.some(a => a.username === u)) { alert("اسم المستخدم مُستخدم بالفعل"); return; }
      accounts.push({username: u, password: p, numbers: []});
      saveAccounts(accounts);
      alert("✅ تم إنشاء الحساب. يمكنك الآن تسجيل الدخول.");
      document.getElementById('username').value = u;
      document.getElementById('password').value = "";
    }

    // تسجيل دخول
    function doLogin(){
      const u = document.getElementById('username').value.trim();
      const p = document.getElementById('password').value.trim();
      if (!u || !p) { alert("ادخل اسم مستخدم وكلمة مرور"); return;}
      const accounts = loadAccounts();
      const acc = accounts.find(a => a.username === u && a.password === p);
      if (!acc) { alert("بيانات الدخول غير صحيحة"); return;}
      setSession(u);
      // اظهار الواجهة المناسبة
      if (u === "mm") {
        // مالك
        document.getElementById('authCard').style.width = "740px";
        document.getElementById('adminPanel').style.display = "block";
        document.getElementById('userPanel').style.display = "block";
        renderAdminAccounts();
        renderUserPanel(u);
      } else {
        // مستخدم عادي
        document.getElementById('adminPanel').style.display = "none";
        document.getElementById('userPanel').style.display = "block";
        renderUserPanel(u);
      }
    }

    // عرض بيانات المستخدم المسجل (أرقامه)
    function renderUserPanel(username){
      const accounts = loadAccounts();
      const acc = accounts.find(a => a.username === username);
      document.getElementById('welcome').innerHTML = `<b>مرحباً، ${escapeHtml(username)}</b>`;
      const el = document.getElementById('myNumbers');
      if (!acc || !acc.numbers || acc.numbers.length === 0) {
        el.innerHTML = "<i>لا توجد أرقام مضافة لهذا الحساب.</i>";
      } else {
        el.innerHTML = acc.numbers.map(n => escapeHtml(n)).join("<br>");
      }
    }

    // تسجيل خروج
    function logout(){
      clearSession();
      // اعادة الواجهة للوضع الافتراضي
      document.getElementById('adminPanel').style.display = "none";
      document.getElementById('userPanel').style.display = "none";
      document.getElementById('authCard').style.width = "360px";
      document.getElementById('username').value = "";
      document.getElementById('password').value = "";
      alert("تم تسجيل الخروج");
    }

    // مساعدة للسلامة عند عرض نصوص داخل HTML
    function escapeHtml(s){
      if (!s && s !== 0) return "";
      return String(s).replace(/[&<>"'`=\/]/g, function(ch){
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[ch];
      });
    }

    // عند التحميل - إذا هناك جلسة مفتوحة نعيد فتحها
    (function init(){
      // render admin compact hidden by default
      const sess = getSession();
      if (sess) {
        document.getElementById('username').value = sess;
        // محاولة ملء كلمة المرور فارغة (لن نحتفظ بها)
        // نفعل تسجيل دخول تخيلي (باقي التحقق طبيعي)
        // لإنهاء التجربة، المستخدم يحتاج يعيد كتابة الباسورد عند الحاجة أو نحظر إعادة دخول تلقائي.
      }
    })();

    // إضافة listeners
    document.getElementById('fileInput').addEventListener('change', handleFile);

    // لتسهيل الاختبار: دالة عامة للوصول من الConsole
    window._Kobra = {loadAccounts, saveAccounts, generateAccounts, renderAdminAccounts};

  </script>
</body>
</html>
